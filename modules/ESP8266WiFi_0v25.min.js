function n(a){var c=a.indexOf(":");if(0>c)return a;var b=a.substring(5,c).split(",");b[1]|=0;var f=a.length-(c+1);if(f>=b[1])return h[b[0]]+=a.substr(c+1,b[1]),a.substr(c+b[1]+1);h[b[0]]+=a.substr(c+1,f);return"+IPD,"+b[0]+","+(b[1]-f)+":"}var g,d=[],h=["","","","",""],m=["open","wep","wpa_psk","wpa2_psk","wpa_wpa2_psk"],p={create:function(a,c){if(void 0===a)return b=5,d[b]="Wait",h[b]="",g.cmd("AT+CIPSERVER=1,"+c+"\r\n",1E4,function(a){"OK"==a?d[b]=!0:(d[b]=void 0,setTimeout(function(){throw Error("CIPSERVER failed ("+
(a?a:"Timeout")+")");},0))}),5;for(var b=0;void 0!==d[b];)b++;if(5<=b)throw Error("No free sockets");d[b]="Wait";h[b]="";g.cmd("AT+CIPSTART="+b+',"TCP",'+JSON.stringify(a)+","+c+"\r\n",1E4,function k(a){if(a==b+",CONNECT")return d[b]=!0,k;"OK"==a?g.registerLine(b+",CLOSED",function(){g.unregisterLine(b+",CLOSED");d[b]=void 0}):(d[b]=void 0,setTimeout(function(){throw Error("CIPSTART failed ("+(a?a:"Timeout")+")");},0))});return b},close:function(a){"Wait"==d[a]?d[a]="WaitClose":void 0!==d[a]&&g.cmd((5==
a?"AT+CIPSERVER=0":"AT+CIPCLOSE="+a)+"\r\n",1E3,function(c){d[a]=void 0})},accept:function(a){for(a=0;5>a;a++)if(h[a]&&void 0===d[a])return d[a]=!0,a;return-1},recv:function(a,c){if(g.isBusy()||"Wait"==d[a])return"";if(h[a]){var b;h[a].length>c?(b=h[a].substr(0,c),h[a]=h[a].substr(c)):(b=h[a],h[a]="");return b}return d[a]?"":-1},send:function(a,c){if(g.isBusy()||"Wait"==d[a])return 0;if(!d[a])return-1;g.cmd("AT+CIPSEND="+a+","+c.length+"\r\n",1E4,function f(k){if("OK"==k)return g.register("> ",function(){g.unregister("> ");
g.write(c);return""}),f;if(k=="Recv "+c.length+" bytes")return f;"SEND OK"==k?("WaitClose"==d[a]&&p.close(a),d[a]=!0):(d[a]=void 0,g.unregister("> "))});d[a]="Wait";return c.length}},l={ipdHandler:n,debug:function(){return{socks:d,sockData:h}},init:function(a){g.cmd("ATE0\r\n",1E3,function b(f){if("ATE0"==f)return b;"OK"==f?g.cmd("AT+CIPMUX=1\r\n",1E3,function(b){"OK"!=b?a("CIPMUX failed: "+(b?b:"Timeout")):a(null)}):a("ATE0 failed: "+(f?f:"Timeout"))})},reset:function(a){g.cmd("\r\nAT+RST\r\n",1E4,
function b(f){if("ready"==f||"Ready."==f)setTimeout(function(){l.init(a)},1E3);else if(void 0===f)a("No 'ready' after AT+RST");else return b})},getVersion:function(a){g.cmd("AT+GMR\r\n",1E3,function(c){a(null,c)})},connect:function(a,c,b){g.cmd("AT+CWMODE=1\r\n",1E3,function(f){"no change"!=f&&"OK"!=f?b("CWMODE failed: "+(f?f:"Timeout")):g.cmd("AT+CWJAP="+JSON.stringify(a)+","+JSON.stringify(c)+"\r\n",2E4,function q(a){if(0<=["WIFI DISCONNECT","WIFI CONNECTED","WIFI GOT IP","+CWJAP:1"].indexOf(a))return q;
"OK"!=a?setTimeout(b,0,"WiFi connect failed: "+(a?a:"Timeout")):setTimeout(b,0,null)})})},getAPs:function(a){var c=[];g.cmdReg("AT+CWLAP\r\n",5E3,"+CWLAP:",function(a){a=a.slice(8,-1).split(",");c.push({ssid:JSON.parse(a[1]),enc:m[a[0]],signal:parseInt(a[2]),mac:JSON.parse(a[3])})},function(b){a(null,c)})},getConnectedAP:function(a){var c;g.cmdReg("AT+CWJAP?\r\n",1E3,"+CWJAP:",function(a){c=JSON.parse(a.slice(7))},function(b){a(null,c)})},createAP:function(a,c,b,f,d){g.cmd("AT+CWMODE=2\r\n",1E3,function(h){"no change"!=
h&&"OK"!=h&&"WIFI DISCONNECT"!=h&&d("CWMODE failed: "+(h?h:"Timeout"));h=f?m.indexOf(f):0;0>h?d("Encryption type "+f+" not known - "+m):g.cmd("AT+CWSAP="+JSON.stringify(a)+","+JSON.stringify(c)+","+b+","+h+"\r\n",5E3,function(a){"OK"!=a?d("CWSAP failed: "+(a?a:"Timeout")):d(null)})})},getConnectedDevices:function(a){var c=[];this.at.cmd("AT+CWLIF\r\n",1E3,function f(d){if("OK"==d)a(null,c);else if(void 0===d||"ERROR"==d)a("Error");else return e=d.split(","),c.push({ip:e[0],mac:e[1]}),f})},getIP:function(a){var c;
g.cmdReg("AT+CIFSR\r\n",1E3,"+CIFSR",function(a){!c&&0<=a.indexOf(",")&&(c=JSON.parse(a.slice(a.indexOf(",")+1)))},function(b){"OK"!=b?a("CIFSR failed: "+b):a(null,c)})}};exports.connect=function(a,c){l.at=g=require("AT").connect(a);require("NetworkJS").create(p);g.register("+IPD",n);l.reset(c);return l}