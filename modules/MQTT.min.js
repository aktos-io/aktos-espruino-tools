function h(b,a){this.server=b;a=a||{};this.port=a.port||this.C.DEF_PORT;this.client_id=a.client_id||n();this.keep_alive=a.keep_alive||this.C.DEF_KEEP_ALIVE;this.clean_session=a.clean_session||!0;this.username=a.username;this.password=a.password;this.connected=this.client=!1;this.ping_interval=this.keep_alive<this.C.PING_INTERVAL?this.keep_alive-5:this.C.PING_INTERVAL;this.protocol_name=a.protocol_name||"MQTT";this.protocol_level=g(parseInt((a.protocol_level||l.PROTOCOL_LEVEL).toString(16),
16))}function k(b){return g(b.length>>8,b.length&255)+b}function m(b,a,d){b=g(b);var c=a.length+d.length,e="";do encByte=c&127,c>>=7,0<c&&(encByte+=128),e+=g(encByte);while(0<c);return b+e+a+d}function p(b){if(5<b.length){var a=b.charCodeAt(0),d=b.charCodeAt(1),c=b.charCodeAt(2)<<8|b.charCodeAt(3);return{topic:b.substr(4,c),message:b.substr(4+c,d-c),dup:(a&8)>>3,qos:(a&6)>>1,retain:a&1}}}function q(b,a,d){var c=f.PUBLISH<<4|d<<1,e=g(l.PACKET_ID<<8,l.PACKET_ID&255);b=0===d?k(b):k(b)+e;return m(c,b,
a)}function r(b,a){var d=f.SUBSCRIBE<<4|2,c=g(l.PACKET_ID<<8,l.PACKET_ID&255);return m(d,c,k(b)+g(a))}function t(b){var a=f.UNSUBSCRIBE<<4|2,d=g(l.PACKET_ID<<8,l.PACKET_ID&255);return m(a,d,k(b))}var l={PACKET_ID:1,PROTOCOL_LEVEL:4},f={CONNECT:1,CONNACK:2,PUBLISH:3,PUBACK:4,PUBREC:5,PUBREL:6,PUBCOMP:7,SUBSCRIBE:8,SUBACK:9,UNSUBSCRIBE:10,UNSUBACK:11,PINGREQ:12,PINGRESP:13,DISCONNECT:14};h.prototype.C={DEF_QOS:0,DEF_PORT:1883,DEF_KEEP_ALIVE:60,CONNECT_TIMEOUT:5E3,PING_INTERVAL:40};var g=String.fromCharCode,
n=function(){function b(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return b()+b()+b()}}();h.prototype.connect=function(b){var a=this,d=function(){console.log("Client connected");b.write(a.mqttConnect(a.client_id));a.ctimo=setTimeout(function(){a.disconnect()},a.C.CONNECT_TIMEOUT);a.pintr=setInterval(function(){a.ping()},1E3*a.ping_interval);b.on("data",function(c){var e=c.charCodeAt(0)>>4;if(e===f.PUBLISH)c=p(c),a.emit("publish",c),a.emit("message",c.topic,
c.message);else if(e!==f.PUBACK&&e!==f.SUBACK&&e!==f.UNSUBACK)if(e===f.PINGREQ)b.write(f.PINGRESP+"\x00");else if(e===f.PINGRESP)a.emit("ping_reply");else if(e===f.CONNACK)if(clearTimeout(a.ctimo),c=c.charCodeAt(3),0===c)a.connected=!0,console.log("MQTT connection accepted"),a.emit("connected"),a.emit("connect");else{switch(c){case 1:mqttError+="unacceptable protocol version.";break;case 2:mqttError+="identifier rejected.";break;case 4:mqttError+="bad user name or password.";break;case 5:mqttError+=
"not authorized.";break;default:mqttError+="uknown reason."}console.log(mqttError);a.emit("error",mqttError)}else console.log("MQTT unsupported packet type: "+e),console.log("[MQTT]"+c.split("").map(function(a){return a.charCodeAt(0)}))});b.on("end",function(){console.log("MQTT client disconnected");clearInterval(a.pintr);a.emit("disconnected");a.emit("close")});a.client=b};b?d():b=require("net").connect({host:a.server,port:a.port},d)};h.prototype.disconnect=function(b,a){this.client.write(g(f.DISCONNECT<<
4)+"\x00");this.client.end();this.connected=this.client=!1};h.prototype.publish=function(b,a,d){this.client.write(q(b,a,d||this.C.DEF_QOS))};h.prototype.subscribe=function(b,a,d){a||(a={qos:this.C.DEF_QOS});"number"===typeof a&&(a={qos:a});var c=[];"string"===typeof b&&(b=[b]);Array.isArray(b)?b.forEach(function(b){c.push({topic:b,qos:a.qos})}):Object.keys(b).forEach(function(a){c.push({topic:a,qos:obj[a]})});c.forEach(function(a){this.client.write(r(a.topic,a.qos))}.bind(this));"function"===typeof d&&
d()};h.prototype.unsubscribe=function(b){this.client.write(t(b))};h.prototype.ping=function(){this.client.write(g(f.PINGREQ<<4)+"\x00")};h.prototype.createFlagsForConnection=function(b){var a;a=0|(this.username?128:0);a|=this.username&&this.password?64:0;a|=b.clean_session?2:0;return g(parseInt(a.toString(16),16))};h.prototype.mqttConnect=function(b){var a=f.CONNECT<<4;b=this.createFlagsForConnection({clean_session:b});var d=g(this.keep_alive>>8,this.keep_alive&255),c=k(this.client_id);this.username&&
(c+=k(this.username),this.password&&(c+=k(this.password)));return m(a,k(this.protocol_name)+this.protocol_level+b+d,c)};exports.create=function(b,a){return new h(b,a)};exports.connect=function(b){b=new h(b.host,b);b.connect();return b}