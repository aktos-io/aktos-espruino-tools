function e(a,b){this.socket=null;b=b||{};this.host=a;this.port=b.port||80;this.protocolVersion=b.protocolVersion||13;this.origin=b.origin||"Espruino";this.keepAlive=1E3*b.keepAlive||6E4}var k=String.fromCharCode;e.prototype.initializeConnection=function(){require("net").connect({host:this.host,port:this.port},this.onConnect.bind(this))};e.prototype.onConnect=function(a){this.socket=a;var b=this;a.on("data",this.parseData.bind(this));a.on("close",function(){b.emit("close")});this.emit("open");
this.handshake()};e.prototype.parseData=function(a){var b=this;this.emit("rawData",a);-1<a.indexOf("HSmrc0sMlYUkAGmm5OPpG2HaGWk=")&&(this.emit("handshake"),setInterval(function(){b.send("ping",137)},this.keepAlive));var d=a.charCodeAt(0)&15;if(10==d)return this.emit("pong");if(9==d)return this.send("pong",138),this.emit("ping");if(8==d)this.socket.end();else if(1==d){d=a.charCodeAt(1)&127;if(126<d)throw"Messages >125 in length unsupported";var g=2,e=[0,0,0,0];a.charCodeAt(1)&128&&(e=[a.charCodeAt(g++),
a.charCodeAt(g++),a.charCodeAt(g++),a.charCodeAt(g++)]);for(var f="",c=0;c<d;c++)f+=String.fromCharCode(a.charCodeAt(g++)^e[c&3]);this.emit("message",f)}};e.prototype.handshake=function(){this.socket.write(["GET / HTTP/1.1\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==","Sec-WebSocket-Version: "+this.protocolVersion,"Origin: "+this.origin,"\r\n"].join("\r\n"))};e.prototype.send=function(a,b){this.socket.write(k(void 0===b?129:b,a.length));this.socket.write(a)};
exports=function(a,b){var d=new e(a,b);d.initializeConnection();return d};exports.createServer=function(a,b){var d=require("http").createServer(function(b,h){if("Upgrade"==b.headers.Connection){var f=b.headers["Sec-WebSocket-Key"],f=btoa(E.toString(require("crypto").SHA1(f+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11")));h.writeHead(101,{Upgrade:"websocket",Connection:"Upgrade","Sec-WebSocket-Accept":f,"Sec-WebSocket-Protocol":b.headers["Sec-WebSocket-Protocol"]});h.write("");var c=new e(void 0,{});c.socket=
h;b.on("data",c.parseData.bind(c));b.on("close",function(){clearInterval(c.srvPing);c.srvPing=void 0;c.emit("close")});c.srvPing=setInterval(function(){c.emit("ping",!0);c.send("ping",137)},c.keepAlive);d.emit("websocket",c)}else a(b,h)});return d}